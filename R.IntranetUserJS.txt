R.IntranetUserJS

----------

Name: IntranetUserJS

----------

Options: 70|10

----------

Description: Custom javascript for inclusion in Intranet

----------

Type: Free

----------

$(document).ready(function() {
//never delete anything above this comment

//TEST SERVER
 //BEGIN blue background on test
  var url = $(location).attr('href');
  if(url.indexOf("staff-test") != -1){
   $("body").css("background","#bbe1f5");
   $(".gradient").prepend("<div><li>TESTING IN PROGRESS</li></div>");
  }

//KOHA
 //KOHA > Login screen
  //BEGIN Disable password autofill and hide library dropdown
   $("#main_auth #login input").attr("autocomplete","false | random-string");
   $("#login #password").parent().prepend("<div style='display: none;'><input type='password' name='password_fake' id='password_fake' value='' autocomplete='password'><input type='text' name='userid' id='userid fake' value=''></div>");

  //BEGIN add message to login page
   $("#main_auth.main #login").parent().prepend("<h3 id='upgrade_note2' class='upgrade'><font color='#ff0000'>The NExpress catalog was upgraded on the evening of Saturday, July 28, 2018.<br /><br />Remember that you must clear your Firefox cache (type ctrl-shift-delete while you have Firefox open) the first time you log in after the upgrade in order to make sure there are no old NExpress pages interfering with the new version of NExpress.<br /><br />If you don't know how to do that, please <span class='highlight'><strong><a href='https://drive.google.com/file/d/0B1y1vSumiZCKaEV4aC11eWgtUlU/view' target='_blank'>click here</a></strong></span> for instructions.</font></h3>");

 //Koha > * (all pages)
  //BEGIN Prevent doing a Checkout search for short strings
   $("#patronsearch").on('submit', function(e){
    e.preventDefault();
    var len = $('#findborrower').val().length;
    if (len > 3 && len > 1) {
     this.submit();
     } else {
     alert("Please enter four or more characters to perform a checkout search to avoid returning too many results");
    }
   });

  //BEGIN Fix searches by striping parenthesis and semicolons from links
   $('a[href*="search.pl"]').attr('href', function(_,v){
    return v.replace(/(\w)(\(|\)|\;)(\w)/g,'$1 $3')
      }).attr('href', function(_,v){
    return v.replace(/(\(|\)|\;)/g,'')
   });

  //BEGIN disable autocomplete in checkout box
   $("#patronsearch").attr("autocomplete","off");

  //BEGIN re-logo the staff client
   //Login page
   //url for new logo - change on July 31 after closing http://nekls.org/wp-content/uploads/2018/03/nekls_next_logo.png
    $("#login > form").before('<h2 id="newlogo" style="text-align: center;"><a href="http://nekls.org/"><img src="http://nekls.org/wp-content/uploads/2018/03/nekls_next_logo.png" height="50" width="150"><p style="font-size: 75%;">A service of NEKLS</p></a></h2>');
   //All other pages
    $("#header_search").before('<div id="newlogo" style="float: left; padding: 10px; height: 88;"><a href="/cgi-bin/koha/mainpage.pl"><img src="http://nekls.org/wp-content/uploads/2018/03/nekls_next_logo.png" height="50" width="150"><p style="font-size: 75%;">A service of NEKLS</p></a></div>');

 //KOHA > * (all pages with breadcrumbs)
  //BEGIN add message to all screens with breadcrumbs - requires css to hide ids and classes (good for upgrade notes, etc.)
   $("#breadcrumbs").prepend("<h4 id='upgrade_note1' class='upgrade' style='display: none'>The NExpress catalog will be upgraded on the evening of DAY, MONTH DD, YYYY.<br />While the catalog is being upgraded patrons will not be able to access the OPAC.<br />Look in the NEWS column on the left hand side of the NExpress homepage for more information.</font></h4><h4 id='upgrade_note2' class='upgrade' ><font color='#ff0000'>The NExpress catalog was upgraded on the evening of Saturday, July 28, 2018.<br /><br />Remember that you must clear your Firefox cache (type ctrl-shift-delete while you have Firefox open)<br />the first time you log in after the upgrade in order to make sure there are no old NExpress pages interfering with the new version of NExpress.<br /><br />Look in the NEWS column on the left hand side of the NExpress homepage for more information.</font></h4>");
   $('.upgrade').mouseenter(function() {
    $( ".upgrade" ).css("background-color","#FFFF00");
   });
   $('.upgrade').mouseleave(function() {
    $( ".upgrade" ).css("background-color","#E6F0F2");
   });

//Administration > Circulation and fine rules
 //BEGIN Click on rule to move it to the bottom of the table
   $("#default-circulation-rules tr:contains(Edit)").click(function() {
    $(this).insertBefore("#edit_row");
   });

 //BEGIN Create button to hide left hand navigation
  $("#admin_smart-rules #navmenu").parent().prepend("<button id='navhide' type='button' style='margin: 5px'>Hide admin column</button>");
  $("#navhide").click( function() {
   $("#navhide, #navmenu").hide();
   $(".yui-t1 #yui-main .yui-b").css("margin-left", "1em");
  });

 //BEGIN Hide unneeded columns in circulation rules by clicking on header (--requires corresponding css--)
  $("#default-circulation-rules thead th").append("<br /><br /><span>Hide<br />Column</span>");
  $('#default-circulation-rules thead th').click(function() {
   var index = (this.cellIndex + 1);
   var cells = $('#default-circulation-rules tr > :nth-child(' + index + ')');
   cells.toggleClass('hiderule');
   if ($(this).hasClass('hiderule')) {
    $(this).find('span').html('+');
    } else {
    $(this).find('span').html('Hide<br />Column');
   }
   if ($('table tr > th:not(.collapsed)').length)
    $('table').removeClass('collapsed');
     else
    $('table').addClass('collapsed');
   });

 //BEGIN hide columns by default
  $("#default-circulation-rules th:nth-child(14), #default-circulation-rules td:nth-child(14)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(15), #default-circulation-rules td:nth-child(15)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(16), #default-circulation-rules td:nth-child(16)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(19), #default-circulation-rules td:nth-child(19)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(20), #default-circulation-rules td:nth-child(20)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(21), #default-circulation-rules td:nth-child(21)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(22), #default-circulation-rules td:nth-child(22)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(27), #default-circulation-rules td:nth-child(27)").addClass("hiderule");
  $("#default-circulation-rules th:nth-child(28), #default-circulation-rules td:nth-child(28)").addClass("hiderule");
  $("#default-circulation-rules > thead > tr > th.hiderule > span").html("+");

 //BEGIN Sort circulation rules by clicking on footer
   $('#default-circulation-rules tfoot tr th').click(function(){
     var table = $(this).parents('table').eq(0)
     var rows = table.find("tbody tr").toArray().sort(comparer($(this).index()))
     this.asc = !this.asc
     if (!this.asc){rows = rows.reverse()}
     for (var i = 0; i < rows.length; i++){table.append(rows[i])}
   })
   function comparer(index) {
     return function(a, b) {
       var valA = getCellValue(a, index), valB = getCellValue(b, index)
       return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
     }
   }
   function getCellValue(row, index){
     return $(row).children('td').eq(index).text()
   }
   $("#default-circulation-rules #edit_row").insertBefore("tfoot");

//Administration > Libraries and groups > Modify library
 //BEGIN Branch input - relabel address line input
  $("#admin_branches.admin label[for='branchaddress1']").html("Mailing address:");
  $("#admin_branches.admin label[for='branchaddress2']").html("Street address /<br />Physical address:");
  $("#admin_branches.admin label[for='branchaddress3']").html("Director / ILL contact:");

//Catalog//
 //BEGIN Make patron link title details page go to "Circulation > Checkouts > -PATRONNAME-" instead of "Patrons > Patron details for -PATRONNAME-"
  $('#catalog_detail a').each(function() {
   this.href = this.href.replace('members/moremember.pl', 'circ/circulation.pl');
  });

 //BEGIN Toggle "Show contents"
  $('#catalog_detail .contentblock').hide();
  $('#catalog_detail span:contains("Contents")').html('<div class="contents_s" style="text-align: left; display: block;"><h2>Click to show contents</h2></div><div class="contents_h" style="text-align: left; display: none;"><h2>Click to hide contents</h2></div>');
  $('#catalog_detail .contentblock, .contents_s, .contents_h').click(function() {
   $('#catalog_detail .contentblock, .contents_s, .contents_h').toggle();
  });

//Catalog > Details for -TITLE-//
 //BEGIN Redirect NoveList Select links to the staff client instead of the OPAC
  $("li:contains('NoveList Select')").click(function() {
   $("#NovelistSelect a").each(function() {
    this.href = this.href.replace('catalog.nexpresslibrary.org/cgi-bin/koha/opac-search.pl', 'staff.nexpresslibrary.org/cgi-bin/koha/catalogue/search.pl');
   })
  });

//Cataloging > Edit TITLE > Items
 $('#subfield9523').hide();

//Catalog > Item details for -TITLE-
 //BEGIN Hide lost value 2  (Lost (more than 45 days overdue)) from item details screen
  $("div.listgroup:nth-child(3) > ol:nth-child(2) > li:nth-child(4) > form:nth-child(2) > select:nth-child(4) option[value='2']").hide();

//Catalog > -TITLE- > Place a hold on -TITLE-//
 //BEGIN Make patron link on this page go to "Circulation > Checkouts > -PATRONNAME-" instead of "Patrons > Patron details for -PATRONNAME-"
  $('#circ_request a').each(function() {
   this.href = this.href.replace('members/moremember.pl', 'circ/circulation.pl');
  });

//Catalog > Search
 //BEGIN Puts the cursor in the search field on the results screen
  $("#catalog_results #search-form").focus();

//Catalog > Search for SEARCHTERMS
 //BEGIN change "available" to "not checked out"
  $('#bookbag_form > table > tbody > tr td:last-child > div > strong').each(function() {
   var text = $(this).text();
   $(this).text(text.replace(' available', ' not checked out'));
  });

 //BEGIN Toggle non-local copies in search results
  //Create buttons to revert view
   $("#catalog_results #selection_ops").append('<div class="btn-group" style="padding-left: 50px"><a class="btn btn-default btn-xs" id="results_sh" href="#" style="display: block; width: 125px; border-radius: 5px;"><span id="results_all" style="display: block;">Show all copies</span><span id="results_loc" style="display: none;">Show local copies</span></a></div>');
   $("#results_all").click(function(){
    $("#results_loc").show();
    $("#results_all").hide();
    $(".availability").children("ul").show();
    return false;
   });
   $("#results_loc").click(function(){
    $("#results_loc").hide();
    $("#results_all").show();
    $(".availability").children("ul").hide();
    return false;
   });

  //Show only ‘Local Copies [logged in library]’ or ‘No Local Copies’ in staff search results
   var loglibnode=$("span.logged-in-branch-name:nth-child(1)").text().trim();
   $(".availability").each(function(){
    var ownedlocal=false;
    var our_copy_item;
    $(this).children("ul").each(function(){
     our_copy_item=$(this).find('li:contains("'+loglibnode+'")')
     if(our_copy_item.length){
      ownedlocal=true;
      $(this).parent('.availability').after("<ul>",our_copy_item,"</ul>");
     }
    });
    $(this).append("<br>Click + OR title for full availability");
    if(ownedlocal){
     $(this).append("<h4><span style='color:green; font-weight:bolder;'>Local copies:</span></h4>");
      } else {
     $(this).append("<br/><p><span style='color:red; font-weight:bold;'>No local copies</span></p>");
    }
   });
  //Condense Locations on Staff Catalog Results
   $("#bookbag_form div[class='availability']").children("ul").hide();
   $("#bookbag_form div[class='availability'] strong").wrap("<a class='viewLocations' />");
   $("#bookbag_form div[class='availability'] strong").append("<span class='instruct'> (+)</span><span class='instruct' style='display: none;'> (-)</span>");
   $("#bookbag_form div[class='availability']").parent("td").attr('width','290');
  //Trigger for condensed locations
   $(".viewLocations").click(function() {
    $(this).find(".instruct").toggle();
    $(this).parent().parent().find("ul").toggle("slow");
   });

//Catalog > TITLE > Place a hold on TITLE
 //BEGIN changes default item sort order to Home library
  $('#requestspecific').on( 'init.dt', function () {
   $(this).dataTable().fnSort( [ $(this).find('tr[role=row] th:contains("Home library")').index('th'), 'asc' ] );
  });

 //BEGIN Set newly placed holds in staff client to expire after one year if not filled
  var holdtodate = new Date();
  var day = ("0" + holdtodate.getDate()).slice(-2);
  var month = ("0" + (holdtodate.getMonth() + 1)).slice(-2);
  var year = ("0" + (holdtodate.getFullYear() + 1)).slice(-4);
  var holdtill = (month) + "/" + (day) + "/" + (year);
  $('#hold-request-form #to').val(holdtill);

//Cataloging
 //BEGIN Hide Z, DVD, and Online resource Frameworks
  $("#cat_addbooks li:contains('Z Framework')").hide();
  $("#cat_addbooks li:contains('DVD framework')").hide();
  $("#cat_addbooks li:contains('Online resource')").hide();

 //BEGIN Hide merge button on cataloging search
  $("#cat_addbooks .merge-items").hide();

//Cataloging > Edit -TITLE- > Items
 //BEGIN Hide lost value 2  (Lost (more than 45 days overdue)) from item edit screen
  $("#subfield9521 select option[value='2']").remove();
 //BEGIN add focus to search bar after adding an item
  $("#cat_additem input[name=q]:eq(0)").focus();

//Cataloging > Edit -TITLE- > Items
 //BEGIN Hide lost value 2  (Lost (more than 45 days overdue)) from item edit screen
  $("#subfield9521 select option[value='2']").remove();

 //BEGIN add focus to search bar after adding an item
  $("#cat_additem input[name=q]:eq(0)").focus();

//Cataloging > Z39.50/SRU search
 //BEGIN Resize Z39.50 window
  if (document.location.href.indexOf('z3950_search.pl')>-1) window.resizeTo(940, 800);
  $("#cat_z3950_search #custom-doc").css("height", 675).css("width", 900);
  $("#cat_z3950_search #custom-doc #z3950_search_targets").css("height", 610);
  $("#cat_z3950_search #custom-doc .yui-u.first .rows").css("height", 610);

//Circulation > *
 //Affects any pages where you can add a message to the patron's account
 //BEGIN renames "note" to "message" where appropriate
  $("#message_type option[value='L']").html("Staff - Internal message");
  $("#circ_circulation label[for='select_patron_messages']").html("Predefined messages: ");
  $("#select_patron_messages option:contains(Select note)").html("Select message");

 //BEGIN Remove Transfer, Set library, Fast cataloging, and Offline circulation links from left column and left sidebar
  $("#bd div[class='yui-u first'] li:contains('Transfer')").hide();
  $("#bd div[class='yui-u first'] li:contains('Fast cataloging')").hide();
  $("#bd div[class='yui-u'] h5:contains('Offline circulation')").parent().hide();
  $("#navmenulist > ul:nth-child(3) > li:nth-child(4), #navmenulist > ul:nth-child(3) > li:nth-child(5), #navmenulist > ul:nth-child(3) > li:nth-child(6)").remove();

 //BEGIN Removes Holds to pull link from right column and left sidebar
  $(".circ a:contains('Holds to pull')").parent().remove();

//Circulation › Check in

 //BEGIN redirect patron data to check-out instead of details
  $("#circ_returns .ci-patron a").each(function() {
   this.href = this.href.replace('members/moremember.pl', 'circ/circulation.pl');
  });

 //BEGIN "Patron note" modifications

  //BEGIN adds ID to the patron note message
   $("#circ_returns .dialog.message:contains('Patron note')").attr('id', 'ppnote');

  //BEGIN adds an ID to the last barcode number checked in and its home library (allows us to put these into the note later)
   $("tr:nth-child(1) td:nth-child(4) a").attr('id', 'lastbcin');
   $("tr:nth-child(1) td:nth-child(5)").attr('id', 'lasthome');

  //BEGIN removes focus from the barcode input
   if ($("#ppnote").length){
    $("#barcode").blur();
   }

  //BEGIN embiggens the title and the note and adds identifiers
   $('#ppnote p:nth-of-type(2n)').wrapInner("<span style='font-size: 110%;'>Title: </span>");
   $('#ppnote p:nth-of-type(3n)').wrapInner("<span style='font-size: 110%; font-weight: bold;'>The patron says: </span>");

  //BEGIN adds the print button and the e-mail button
   $("#ppnote").last("p").append('<br /><input type="button" id="problemprint" style="margin: 20px; padding: 5px;" value="Print this note"><input type="button" id="problemcopy" style="margin: 20px; padding: 5px;" value="Email this note to the home library">');

  //BEGIN adds the barcode number and the home library of the last checked in item to the note between the title and the patron's note
   $(window).load(function(){
    $('#ppnote p:nth-of-type(2n)').after("<p style='font-size: 110%;'>Item BC: <ins>" + $('#lastbcin').html()+ "</ins></p>");
    $('#ppnote p:nth-of-type(3n)').after("<p style='font-size: 110%;'>Home library: <ins>" + $('#lasthome').html()+ "</ins></p>");
   });

  //BEGIN adds function onto the print button
   $("#problemprint").click(function () {
    $("#barcode").focus();
    var divContents = $("#ppnote").html();
    var problemWindow = window.open('', '', 'height=500,width=500');
    problemWindow.document.write('<html><head><style>body {width: 260px; padding: 10px; word-wrap: break-word} input {display: none;}</style><title></title></head><body><div>');
    problemWindow.document.write(divContents);
    problemWindow.document.write('<h1>Patron note</h1></div></body></html>');
    problemWindow.document.close();

    problemWindow.onload=function(){
     problemWindow.focus();
     problemWindow.print();
     problemWindow.close();
    }
   });

  //BEGIN adds function to the send button
   $("#problemcopy").click(function () {
    var el = document.getElementById("ppnote");
    var range = document.createRange();
    range.selectNodeContents(el);
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    document.execCommand('copy');
    window.open("http://news.nexpresslibrary.org/patron-placed-problem-notes/", "_blank");
    $("#barcode").focus();
   });

//Circulation > Checkouts > PATRONNAME

 //BEGIN Prevents unauthorized use of ILL cards
  //LEAVENWORTH
   $('#circ_circulation, #pat_moremember').each(function(){
    if($(".logged-in-branch-name:not(:contains(Leavenworth))", this).length && $(".patroninfo .patronlibrary:contains(Leavenworth)", this).length && $(".patroninfo .patroncategory:contains(ILL)", this).length){
     $('#barcode').hide();
     $('#menu a:contains(Batch check out)').hide();
     $('#toolbar').hide();
    }
   });

  //OTTAWA
   $('#circ_circulation, #pat_moremember').each(function(){
    if($(".logged-in-branch-name:not(:contains(Ottawa))", this).length && $(".patroninfo .patronlibrary:contains(Ottawa)", this).length && $(".patroninfo .patroncategory:contains(ILL)", this).length){
    $('#barcode').hide();
    $('#menu a:contains(Batch check out)').hide();
    $('#toolbar').hide();
   }
  });

 //BEGIN Prevents unauthorized non-school use of school cards
  //PHSD
   $('#circ_circulation, #pat_moremember').each(function(){
    if($(".logged-in-branch-name:not(:contains(Prairie))", this).length && $(".patroninfo .patronlibrary:contains(Prairie)", this).length){
     $('#barcode').hide();
     $('#menu a:contains(Batch check out)').hide();
     $('#toolbar').hide();
     $('.patronlibrary').css('background','#FFFF00');
     $('#barcode').parent().prepend("<p style='background: #FFFF00;font-size: 110%;font-weight: bold;'>Prairie Hills school district accounts can only be used to check out items at school.<br />If the patron wants to check out items at a public library,<br />they must get a public library card (if they do not already have one).</p>");
    }
   });

 //BEGIN Prevents unauthorized non-school use of 239500
 //(also Circulation > Batch check out > PATRONNAME)
 //(also Patrons > |*| for PATRONNAME)
  $(".patroninfo:contains('239500')").attr('patronblock', 'block');
  if ($(".patroninfo").attr('patronblock')) {
   $(".yui-g #mainform").prepend("<p><strong>This is not a patron account - it is a system account.</p><p>Please contact nexpresshelp@nekls.org for more information.</p>");
   $("#toolbar").hide();
   $("#circ_circulation_issue").hide();
   $("#messages.circmessage").hide();
   $(".action").hide();
   $("#menu").hide();
  };

 //BEGIN re-label "Remember for session:" text
  $("#circ_circulation label[for='stickyduedate']").html("Use this date till the browser is closed:");

 //BEGIN Make due date stand out (accompanying css highlights the whole box)
  $('div.lastchecked > p:nth-child(1)').html(function(index, html) {
   return html.replace('Due on', '<mark style="font-size: 18px;"><strong>Due on');
  });
  $('div.lastchecked > p:nth-child(1)').html(function(index, html) {
   return html.replace('</p>', '</mark></strong></p>');
  });

 //BEGIN disable change hold pickup location on tab in checkout since it doesn't work right
 //(also Patrons > Patron details for PATRONNAME)
  $('#reserves').on( 'init.dt', function () {
   $(".hold_location_select").attr("disabled","disabled");
  });

 //BEGIN Rename Renew or check in button
  $(":button:contains('Renew or check in selected items')" ).text("Renew checked items");

 //BEGIN creates "E-mail receipt button" button
  $("#circ_circulation #toolbar #addnewmessageLabel").after("<div class='btn-group'><button id='digreceipt' type='button' class='btn btn-default btn-sm'>One time e-mail receipt</button></div>");
 //opens report 3076 for this patron
  var patronid=$("#borrowernumber").val();
  $("#digreceipt").click( function() {
   window.open('https://staff.nexpresslibrary.org/cgi-bin/koha/reports/guided_reports.pl?reports=3076&phase=Run+this+report&sql_params=' + patronid + '');
  });

 //BEGIN creates "Block check" button
  $("#circ_circulation #toolbar #addnewmessageLabel").after("<div class='btn-group'><button id='blockedrep' type='button' class='btn btn-default btn-sm'>Check blocked status</button></div>");
 //opens report 3079 for this patron
  var patronxid=$("#circ_circulation #message_form > div:nth-child(2) > input:nth-child(4)").val();
  $("#blockedrep").click( function() {
   window.open('https://staff.nexpresslibrary.org/cgi-bin/koha/reports/guided_reports.pl?reports=3079&phase=Run+this+report&sql_params=' + patronxid + '');
  });

//Circulation › Holds awaiting pickup
 //BEGIN Remove "Cancel hold" and "Cancel hold and return" column and buttons
  $("#holdswaiting #holdst").find("tbody td:last-child,thead th:last-child").hide();
  $("#holdsover #holdso").find("tbody td:last-child, thead th:last-child").hide();

 //BEGIN Remove "Cancell all" button an accompanying text at top of screen
  $("form[name='cancelAllReserve']").hide();
  $("#holdsover").contents().filter(function(){
   return this.nodeType === 3;
  }).wrap("<p style='display: none;'></p>");

//Patrons › Manual credit
 //BEGIN Add automatic notes to manual credit
  $("#mancredit > fieldset.action > input[type='submit']").one( "click", function(){
   $("#mancredit #note").val( function( index, val ) {
    return val + " - credit created by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())
   })
  });

//Patrons › Manual invoice
 //BEGIN Add automatic notes to manual invoice
  $("#maninvoice > fieldset.action > input[type='submit']").one( "click", function(){
   $("#pat_maninvoice #note").val( function( index, val ) {
    return val + " - invoice created by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())
   })
  });

//Patrons > PATRONNAME > Add patron|Modify patron
 //BEGIN Collapse unused patron entry boxes
  //Adds elements and components to legends on boxes
   $("#entryform legend").each(function() {
    $(this).append("<span class='instruct' style='display: none;'> (+)</span><span class='instruct'> (-)</span>");
    $(this).wrapInner("<a class='viewSwitch' />");
    $(this).parent().children().not("legend").wrap("<div class='contentsToggle' />");
    $("#memberentry_patron_attributes div:first").removeAttr('class');
   });

  //Pre-hides specified boxes
   if($("#memberentry_identity").is(":visible")) {
    $("#entryform legend:contains('Guarantor information'), #entryform legend:contains('Alternate address'), #entryform legend:contains('Alternate contact'), #entryform legend:contains('Library set-up'), #entryform legend:contains('Patron account flags'), #entryform legend:contains('Patron restrictions'), #entryform legend:contains('Additional attributes and identifiers')").parent().children().not("legend").hide();
   };

  //Shows boxes that already contain data
   $("#aai_EXPIRED").hide();
   if($("#aai_EXPIRED select option:selected").val()!=0){
    $("#aai_EXPIRED").show();
   }

   if($("#contactname").val()!="") {
    $("#entryform legend:contains('Guarantor information')").parent().children().not("legend").show();
   };
   $("#memberentry_address input,#memberentry_altaddress input").each(function() {
    if($(this).val()!="") {
     $(this).parents(".rows").children(".contentsToggle").show();
    };
   });
   if($("#borrowernotes").html()!="") {
    $("#memberentry_subscription").children(".contentsToggle").show();
   };
   $("#entryform legend:contains('Patron account flags')").parents(".rows").find("input").each(function() {
    if($(this).is(':checked') && $(this).val()=="1") {
     $(this).attr('class','thisone');
     $(this).parents(".rows").children(".contentsToggle").show();
    };
   });

  //Update switch labels
   $(".contentsToggle").each(function() {
    if($(this).is(':hidden')) {
     $(this).parent().find(".instruct").toggle();
    };
   });

  //Triggers the click element
   $(".viewSwitch").click(function() {
    $(this).find(".instruct").toggle();
    $(this).parent().parent().children(".contentsToggle").toggle("slow");
   });

  //Patron identity
   //BEGIN rename fields "Surname" to "Last Name," "First Name" to "First/Middle Name," "Other Names" to "Nickname/Other name"
    $("#memberentry_identity label[for='surname']").html("Last name:");
    $("#memberentry_identity label[for='firstname']").html("First name +/<br />middle initial /<br />or middle name:");
    $("#memberentry_identity label[for='othernames']").html("Nickname /<br />other name:");

  //Guarantor information
   //BEGIN rename fields "Surname" to "Last Name," "First Name" to "First/Middle Name"
    $("#memberentry_guarantor label[for='contactname']").html("Last name:");
    $("#memberentry_guarantor label[for='contactfirstname']").html("First name +/<br />middle initial /<br />or middle name:");

  //Main address
   //BEGIN Rename "Zip/Postal Code" to "Zip code"
    $("#entryform label[for='zipcode']").html("Zip code:");

   //BEGIN Move "School" attributes into the Main address block
    $("#aai_School").insertBefore($("#memberentry_mainaddress label[for='address']").parent('li'));

   //BEGIN Move "Expired" attributes into the Main address block
    $("li.radio").parent().append("<li id='lastinname'></p>");
    $("#aai_EXPIRED").insertBefore($("#memberentry_identity"));

  //Contact
   //BEGIN create clear e-mail buttons
    $("#pat_memberentrygen #email").parent().parent().append("<li><label>Clear e-mail:</label><button id='clearprimeemail' type='button' style='margin: 5px'>Clear primary e-mail</button><button id='clearsecondemail' type='button' style='margin: 5px'>Clear secondary e-mail</button>");
    $("#clearprimeemail").click(function() {
     $("#pat_memberentrygen #email").val("")
    });
    $("#clearsecondemail").click(function() {
     $("#pat_memberentrygen #emailpro").val("")
    });

   //BEGIN Move "Holds contact" attributes to Contact box
    $("#aai_Holdscon").insertBefore($("#memberentry_contact label[for='phone']").parent('li'));

  //Alternate address
   //BEGIN Rename "Zip/Postal Code" to "Zip code"
    $("#memberentry_altaddress label[for='altcontactzipcode']").html("Zip code:");

  //Alternate contact
   //BEGIN "Zip/Postal Code" to "Zip Code"
    $("#memberentry_address label[for='B_zipcode']").html("Zip code:");

  //Library Management
   //BEGIN Hide Louisburg and Digital from patron dropdown (Library management)
    $("#pat_memberentrygen option[value='branch:LOUISBURG'], #pat_memberentrygen option[value='LOUISBURG']").hide();
    //$("#pat_memberentrygen option[value='branch:DIGITAL'], #pat_memberentrygen option[value='DIGITAL']").hide();

   //BEGIN Move "Location" and "Permission" attributes into the Library management box
    $("#aai_Location").insertBefore($("#memberentry_library_management label[for='sort1']").parent('li'));
    $("#aai_Permissions").insertBefore($("#memberentry_library_management label[for='sort1']").parent('li'));
    $("#aai_COLLECT").insertBefore($("#memberentry_library_management label[for='sort1']").parent('li'));

  //OPAC/Staff login
   //BEGIN Easy fill username options
    $("#pat_memberentrygen #userid").parent().append("<li><label>Easy-fill<br />username<br />options:</label><br /><button id='cardid' type='button' style='margin: 5px'>Use library card number for username</button><button id='nameid' type='button' style='margin: 5px'>Use firstname.lastname for username (NExpress default)</button><p style='font-size: 125%;color: red;'><br />If a patron has been locked out of their account due to more than 5 failed login attempts, you can only remove the lockout through the <ins>'Change password'</ins> button on the checkout or patron details pages.<br />Assigning a new password here will not clear the lockout.</p>");
    $("#cardid").click( function() {
     $("#entryform #userid").val($("#entryform #cardnumber").val());
    });
    $("#nameid").click( function() {
     $("#entryform #userid").val($("#entryform #firstname").val().toLowerCase().replace(/[^a-zA-Z 0-9]+/g, "").replace(" ","") + '.' +$("#entryform #surname").val().toLowerCase().replace(/[^a-zA-Z 0-9]+/g, "").replace(" ",""));
    });

   //BEGIN Easy fill password buttons
    $("#pat_memberentrygen #password2").parent().append("<button id='deletepass' type='button'>Clear current password data</button>");
    $("#pat_memberentrygen #password2").parent().parent().append("<li><label>Easy-fill<br />password<br />options:</label><button id='lnamepass' type='button' style='margin-right: 5px'>Use last name for password (case sensitive)</button>   <button id='phonepass' type='button'>Use last 4 digits of phone for password</button><br><br>   <button id='townpass' type='button'style='margin-right: 5px'>Use name of town in lowercase letters</button>   <button id='birthpass' type='button'>Use birthdate in format MMDDYYYY (no / marks)</button>");
    $("#phonepass").click( function() {
     $("#entryform #password, #entryform #password2").val($("#entryform #phone").val().slice(-4));
    });
    $("#lnamepass").click( function() {
     $("#entryform #password, #entryform #password2").val($("#entryform #surname").val());
    });
    $("#townpass").click( function() {
     $("#entryform #password, #entryform #password2").val($("#entryform #city").val().toLowerCase());
    });
    $("#birthpass").click( function() {
     $("#entryform #password, #entryform #password2").val($("#entryform #dateofbirth").val().replace(/\//g,''));
    });
    $("#deletepass").click(function() {
     $("#entryform #password, #entryform #password2").val("")
    });

   //Patron messaging preferences
    //BEGIN link Digest and E-mail checkboxes to work in tandem (Patron messaging preferences)
     $('#digest1').on('click', function(){
      var checked = $(this).is(':checked');
      $('#email1').attr('checked', checked);
     });
     $('#digest2').on('click', function(){
      var checked = $(this).is(':checked');
      $('#digest2, #email2').attr('checked', checked);
     });
     $('#email1').on('click', function(){
      var unchecked = $(this).is('checked', false);
      $('#digest1').attr('checked', false);
     });
     $('#email2').on('click', function(){
      var unchecked = $(this).is('checked', false);
      $('#digest2').attr('checked', false);
     });

   //BEGIN Easy fill messaging preferences
    $("#patron_messaging_prefs_lgd").after("<p id='emailbuttons' style='margin: 5px'><button id='holdonly' type='button' style='margin: 5px'>Hold e-mail only</button><button id='5dayemail' type='button' style='margin: 5px'>5 Day advance e-mail + Item due</button><button id='3dayemail' type='button' style='margin: 5px'>3 Day advance e-mail + Item due</button><button id='clearemail' type='button' style='margin: 5px'>Clear all e-mail</button></p>");
    $("#holdonly").click( function() {
     $("#memberentry_messaging_prefs input").prop('checked', false);
     $("#email4").prop('checked', 'checked');
    });
    $("#5dayemail").click( function() {
     $("#email1, #email2, #digest1, #digest2, #email4").attr("checked","checked");
     $("#memberentry_messaging_prefs table select option[value=5]").attr("selected","selected");
    });
    $("#3dayemail").click( function() {
     $("#email1, #email2, #digest1, #digest2, #email4").attr("checked","checked");
     $("#memberentry_messaging_prefs table select option[value=3]").attr("selected","selected");
    });
    $("#clearemail").click( function() {
     $("#email1, #email2, #digest1, #digest2, #email4, #email5, #email6").prop('checked', false);
     $("#memberentry_messaging_prefs table select option[value=0]").attr("selected","selected");
    });

   //BEGIN SMS changes in the staff client
    //BEGIN Hides SMS number and all SMS checkboxes when page is loaded
     $("#SMSnumber").parent().hide();
     $("#sms1, #sms2, #sms4, #sms5, #sms6").attr("disabled","disabled");

   //BEGIN Show SMS number if provider is not null and clear number and all SMS checkboxes if the provider is changed to null
    $("body").on("mousemove change click keyup", function(){
     if($("#sms_provider_id").val() != ""){
      $("#SMSnumber").parent().show("slow");
      } else {
      $("#SMSnumber").parent().hide("slow");
      $("#SMSnumber").val("");
      $("#smsbuttons").hide();
      $("#sms1, #sms2, #sms4, #sms5, #sms6").attr("disabled", "disabled");
      $("#sms1, #sms2, #sms4, #sms5, #sms6").prop("checked", false);
     }
    });

   //BEGIN Enable SMS checkboxes only if SMS number is 10 digits and force SMS number entry to numerals only - no punctuation, alphanumeric characters, or spaces
    $("#SMSnumber").attr('maxlength','10');
    $('#SMSnumber').keydown(function (e) {
     if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
     (e.keyCode == 65 && e.ctrlKey === true) ||
     (e.keyCode >= 35 && e.keyCode <= 40)) {
      return;
     }
     if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
      e.preventDefault();
     }
    });
    $("body #memberentry_messaging_prefs").on("mousemove change click keyup", function(){
     if($("#SMSnumber").val().length == 10){
      $("#sms1, #sms2, #sms4, #sms5, #sms6").removeAttr("disabled");
      $("#smsbuttons").fadeIn("slow");
      } else {
      $("#sms1, #sms2, #sms4, #sms5, #sms6").attr("disabled", "disabled");
      $("#sms1, #sms2, #sms4, #sms5, #sms6").prop("checked", false);
      $("#smsbuttons").fadeOut("slow");
     }
    });

   //BEGIN Move SMS stuff above the table so that the first fields that need to be filled out are the first ones that staff see
    $("#memberentry_messaging_prefs > div:nth-child(7) > table").wrap('<div id="messagetable"></div>');
    $("#memberentry_messaging_prefs label:contains('SMS number:')").parent().wrap('<div id="smsnumbermove"></div>');
    $("#memberentry_messaging_prefs label:contains('SMS provider:')").parent().wrap('<div id="smsprovidermove"></div>');
    $("#smsnumbermove").prependTo("#messagetable").parent();
    $("#smsprovidermove").prependTo("#messagetable").parent();

   //BEGIN Rename SMS "Text messaging" for the sake of staff who don't know what SMS stands for
    $('#memberentry_messaging_prefs label, #memberentry_messaging_prefs th').each(function() {
     var text = $(this).text();
     $(this).text(text.replace('SMS', 'Text message'));
    });

   //BEGIN add links to carrier lookup sites
    $("#smsnumbermove").append("<div><p style='font-weight: bold; text-decoration: underline; color: red;'><br />'Advanced Notices' and 'Item Due' notices (e-mail and text) are sent between 2:00 and 2:30 a.m.<br />Patrons should set the 'Do Not Disturb' settings on their phone appropriately if they do not want their phones to alert them to these notices at that time of day.<br />Instructions for setting the do-not-disturb feature on most phones can be found at<br /><a href='https://www.imore.com/how-to-setup-use-do-not-disturb-iphone-ipad' target='_blank'>Set do-not-disturb for iPhone</a> | <a href='https://www.howtogeek.com/260225/androids-confusing-do-not-disturb-settings-explained/' target='_blank'>Set do-not-disturb for Android phones</a><br /><br />Charges for text messages may be incurred when using this service.<br/>Please have the patron check with their mobile service provider if they have questions about fees for text messages.</p><p style='font-weight: bold; text-decoration: underline;'><br /><a href='https://www.textmagic.com/free-tools/carrier-lookup' target='_blank'>Text Magic - Click here to lookup a mobile phone provider</a><br /><a href='http://freecarrierlookup.com/' target='_blank'>Free Carrier Lookup - Click here to lookup a mobile phone provider (limited to 30 searches per month)</a><br /></p></div>").parent();

   //BEGIN
    $("#sms_provider_id option:contains('Unknown')").text(' Unknown');
    $("#sms_provider_id").one( "click", function() {
     alert("Charges for text messages may be incurred when using this service.  Please have the patron check with their mobile service provider if they have questions about fees for text messages.  Also note that 'Advanced Notices' and 'Item Due' notices are sent at 2:15 a.m.  The patron should set the 'Do Not Disturb' settings on their phone appropriately if they do not want their phones to alert them to these notices at 2:15 a.m.");
     var selexted = $('#sms_provider_id option:selected').val();
     $("#sms_provider_id").html($('#sms_provider_id option').sort(function(x, y) {
      return $(x).text().toUpperCase() < $(y).text().toUpperCase() ? -1 : 1;
     }));
     $("#sms_provider_id").val(selexted);
    });

    $("#emailbuttons").append("<p id='smsbuttons' style='display: none;'> <button id='holdonlysms' type='button' style='margin: 5px'>Hold texts only</button>     <button id='5daysms' type='button' style='margin: 5px'>5 Day advance texts + Item due</button>     <button id='3daysms' type='button' style='margin: 5px'>3 Day advance texts + Item due</button>     <button id='clearsms' type='button' style='margin: 5px'>Clear all texts</button></p>");

    $("#holdonlysms").click( function() {
     $("#sms1, #sms2").prop('checked', false);
     $("#sms4").prop('checked', 'checked');
    });

    $("#5daysms").click( function() {
     $("#sms1, #sms2, #sms4").attr("checked","checked");
     $("#memberentry_messaging_prefs table select option[value=5]").attr("selected","selected");
    });
    $("#3daysms").click( function() {
     $("#sms1, #sms2, #sms4").attr("checked","checked");
     $("#memberentry_messaging_prefs table select option[value=3]").attr("selected","selected");
    });
    $("#clearsms").click( function() {
     $("#sms1, #sms2, #sms4, #sms5, #sms6").prop('checked', false);
     $("#memberentry_messaging_prefs table select option[value=0]").attr("selected","selected");
    });

  //BEGIN adds registration library to field in additional attributes and identifiers
   if (window.location.href.indexOf("cgi-bin/koha/members/memberentry.pl?op=add") > -1 ) {
    $("li label:contains('Registration')").parent().attr("class","reglibrary");
    $(".reglibrary textarea").attr("value",$(".logged-in-branch-name").html());
    $(".reglibrary a").hide();
   }

   if ((window.location.href.indexOf("cgi-bin/koha/members/memberentry.pl?op=modify") > -1 )|| (window.location.href.indexOf("cgi-bin/koha/members/memberentry.pl?op=duplicate") > -1 ) ) {
    $("li label:contains('Registration')").parent().attr("class","reglibrary");
    $(".reglibrary textarea").attr('readonly', true);
    $(".reglibrary a").hide();
   }

//Patrons › PATRONNAME › Modify patron - Patron messaging preferences
  $("#messagetable > table:nth-child(3) > tbody:nth-child(1) > tr:nth-child(5) > td:nth-child(1)").html('Email check-in receipt');
  $("#messagetable > table:nth-child(3) > tbody:nth-child(1) > tr:nth-child(6) > td:nth-child(1)").html('Email check-out/renewal receipt');

//Patrons › Pay fines for PATRONNAME
 //BEGIN Add automatic notes to payments and writeoffs
  $("#payfine .action > input:nth-child(1)").one( "click", function(){
   $("#selected_accts_notes").val( function( index, val ) {
    return val + " - Paid/processed by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())
   })
  });
  $("[name^=pay_indiv]").one( "click", function(){
   $("#finest [name^=payment_note]").val( function( index, val ) {
    return val + " - Paid/processed by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())+ "(pi)"
   })
  });
  $("#woall, [name^=wo_indiv]").one( "click", function(){
   $("#finest [name^=payment_note]").val( function( index, val ) {
    return val + " - Written off/forgiven by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())
   })
  });

 //BEGIN Remove "Reverse" button
  $("#table_account_fines td.actions a:nth-child(2)").hide();

//Patrons › Set permissions for -PATRONNAME-
 //BEGIN Highlight selected permissions
  $("#pat_member-flags input:checked").parent().css("background-color", "yellow");

 //BEGIN buttons to set staff permissions
  $('#pat_member-flags #permissionstree').before('<button id="cleartree" type="button" style="font-size:14px">Clear all</button>  <button id="setdirector" type="button" style="font-size:14px">Set director</button>  <button id="settech" type="button" style="font-size:14px">Set tech</button>  <button id="setcirc" type="button" style="font-size:14px">Set circ</button>  <button id="setassist" type="button" style="font-size:14px">Set assistant</button>  <button id="setsco" type="button" style="font-size:14px">Set SCO</button>');

  $( "#cleartree" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').siblings().css("background-color", "");
   $("#pat_member-flags input").parent().css("background-color", "");
   $('#pat_member-flags li.collapsable').find('div').click();
  });

  $( "#setdirector" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').removeAttr('disabled');
   $('#pat_member-flags').find('#flag-1, #flag-2, #flag-4, #reserveforothers_place_holds, #editcatalogue_edit_catalogue, #editcatalogue_edit_items, #editcatalogue_fast_cataloging, #flag-10, #acquisition_order_manage, #tools_edit_calendar, #tools_edit_news, #tools_edit_notice_status_triggers, #tools_edit_notices, #tools_items_batchdel, #tools_items_batchmod, #tools_label_creator, #tools_manage_patron_lists, #tools_manage_staged_marc, #tools_moderate_comments, #tools_moderate_tags, #tools_stage_marc_import, #tools_upload_general_files, #tools_upload_local_cover_images, #flag-16, #clubs_edit_clubs, #clubs_enroll').each(function() {
    $(this).click();
    $(this).closest('li.expandable').find('div').click();
    $(this).siblings().css("background-color", "yellow");
   });
  });

  $( "#settech" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').removeAttr('disabled');
   $('#pat_member-flags').find('#flag-1, #flag-2, #flag-4, #reserveforothers_place_holds, #editcatalogue_edit_catalogue, #editcatalogue_edit_items, #editcatalogue_fast_cataloging, #flag-10, #acquisition_order_manage, #tools_items_batchdel, #tools_items_batchmod, #tools_label_creator, #tools_manage_patron_lists, #tools_manage_staged_marc, #tools_moderate_comments, #tools_moderate_tags, #tools_stage_marc_import, #tools_upload_general_files, #tools_upload_local_cover_images, #flag-16, #clubs_enroll').each(function() {
    $(this).click();
    $(this).closest('li.expandable').find('div').click();
    $(this).siblings().css("background-color", "yellow");
   });
  });

  $( "#setcirc" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').removeAttr('disabled');
   $('#pat_member-flags').find('#flag-1, #flag-2, #flag-4, #reserveforothers_place_holds, #flag-10, #tools_moderate_comments, #tools_moderate_tags, #reports_execute_reports, #clubs_enroll').each(function() {
    $(this).click();
    $(this).closest('li.expandable').find('div').click();
    $(this).siblings().css("background-color", "yellow");
   });
  });

  $( "#setassist" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').removeAttr('disabled');
   $('#pat_member-flags').find('#circulate_circulate_remaining_permissions, #flag-2, #clubs_enroll').each(function() {
    $(this).click();
    $(this).closest('li.expandable').find('div').click();
    $(this).siblings().css("background-color", "yellow");
   });
  });

  $( "#setsco" ).click(function() {
   $('#pat_member-flags input.flag').removeAttr('checked').removeAttr('disabled');
   $('#pat_member-flags').find('#flag-1').each(function() {
    $(this).click();
    $(this).closest('li.expandable').find('div').click();
    $(this).siblings().css("background-color", "yellow");
   });
  });

//Patrons › Update patron records
 //BEGIN Hide patron update notices from other branches (based on first 4 letters of the branch name)
  $(window).load(function(){
   var loglibnode=$(".logged-in-branch-name").text().trim().substring(0, 3);
   $('#pending_updates h3 a:not(:contains("('+loglibnode+'"))').parent().hide();
   $('#pending_updates a:not(:contains("('+loglibnode+'"))').parent().next('.ui-accordion-content').hide();
  });

//Reports › Guided reports wizard
 //BEGIN Auto-fill today's date in datepicker
  var reportdate1 = new Date();
  var day = ("0" + reportdate1.getDate()).slice(-2);
  var month = ("0" + (reportdate1.getMonth() + 1)).slice(-2);
  var year = ("0" + (reportdate1.getFullYear())).slice(-4);
  var reportdate1 = (month) + "/" + (day) + "/" + (year);
  $("#rep_guided_reports_start #yui-main .yui-b .rows input.datepicker").val(reportdate1);

//Reports › Guided reports wizard › Saved reports
 //BEGIN Hides "Delete selected" button on the bottom of the saved reports table
  //$("#reports_form > fieldset > input[type='submit']").hide();

 //BEGIN Hides "Duplicate" and "Schedule" option on action button
  $("#table_reports a:contains('Duplicate')").hide();
  $("#table_reports a:contains('Schedule')").hide();

//Reports › Guided reports wizard › Saved reports › -REPORTNAME- Report
 //BEGIN Hides SQL output, adds toggle button for SQL and for report info
  $("#rep_guided_reports_start #limitselect").prepend("<p><button id='toginfor'> Toggle report info </button></p>");
  $("#toginfor").click(function(event) {
   event.preventDefault();
   $("#reportinfo").toggle("slow");
  });

//Tools > Automatic item modifications by age
 //BEGIN add Up/Down controls to re-order modification rules
  $("#tools_automatic_item_modification_by_age #rules fieldset legend").each(function(){
    $(this).prepend('<a class="moveup" href="#">- Up - </a>');
  });
  $(".moveup").click(function(){
    $(this).closest("fieldset").insertBefore( $(this).closest("fieldset").prev() );
  });

//Tools > Calendar
 //Disable ability to copy holidays to all calendars
  $('#tools_holidays #allBranches').attr('disabled','disabled');
  $('#tools_holidays #allBranches').parent().hide();

 //Libraries can only modify their own calendars
  var calnode=$(".logged-in-branch-name").text().trim().substring(0, 5);
  $('#tools_holidays .yui-u.first option:not(:contains('+ calnode +'))').hide();

//Tools > News
 //Libraries can only modify their own news
  $("#tools_koha-news .yui-t7 #lang > option:contains('All'), #tools_koha-news .yui-t7 #lang option[value='en'], #tools_koha-news .yui-t7 #lang option[value='es-ES'], #tools_koha-news .yui-t7 #branch option:contains('All libraries')").attr("disabled","disabled");
  $("#tools_koha-news .yui-t7 #lang > option:contains('All'), #tools_koha-news #branch > option:nth-child(1)").removeAttr("selected");
  $("#tools_koha-news .yui-t7 #lang > option:nth-child(2)").attr('selected','selected');
  var newsnode=$(".logged-in-branch-name").text().trim().substring(0, 5);
  $('#tools_koha-news .yui-t7 #branch option:not(:contains('+ newsnode +'))').hide();
  $('#tools_koha-news .yui-t7 #branch option:not(:contains('+ newsnode +'))').attr("disabled","disabled");
  $('#tools_koha-news .yui-t7 #branch option:contains('+ newsnode +')').attr("selected","selected");
  $("#tools_koha-news #number").val("25");

/*
//Tools › Patron card creator › Batches › Edit -BATCHNUMBER-
 //BEGIN Add select all and clear all buttons to card creator batches
  $("#manage-patroncards-layouts > form > h2, #manage-patroncard-batches > form.checkboxed > h2").append('<p><button id="cccheckall">Click here to select all</button>   <button id="ccclearall">Click here to clear all</button></p>');
  $('#cccheckall').click(function() {
   event.preventDefault()
   $("#manage-patroncards-layouts input").prop("checked", true);
   $("#batcht input").prop("checked", true);
  });
  $('#ccclearall').click(function() {
   event.preventDefault()
   $("#manage-patroncards-layouts input").prop("checked", false);
   $("#batcht input").prop("checked", false);
  });
*/

 //BEGIN Change card creator batch codes into names
  $("#manage-patroncards-layouts td:contains(8289)").html("NExpress test cards");

//Tools › Stage MARC records for import
 //BEGIN Add processing tips
  $("#processfile li:contains('Record matching rule')").append("<strong><em>Change to ISBN 020$a</em></strong>");
  $("#processfile li:contains('Action if matching record found')").append("<strong><em> Change to Ignore Incoming</em></strong>");
  $("#processfile li:contains('Action if no match is found')").append("<strong><em> Change to Add Incoming</em></strong>");
  $("#processfile li:contains('How to process items')").append("<strong><em>Change to Add Items only if matching bib was found</em></strong>");




//BEGIN Add features for superusers
  $(".loggedinusername:contains('admin')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('nekls')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('mmcdonald')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('robin.hastings')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('SEKLSLOGIN')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('bywater')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('dan.alexander')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('gwilliams')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('kylemhall')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('ghwtest')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('hbraum')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('greg.gantz')").attr('neklssuperduperuser','yes');
  $(".loggedinusername:contains('bwssupport')").attr('neklssuperduperuser','yes');
  if($(".loggedinusername").attr('neklssuperduperuser')) {

  //Allow superusers to access catalogging editor
    $("#switcheditor").show();

  //Show "Super Librarian" on gradient to identify super users
    $(".gradient").prepend("<li>NExpress Super Librarian!</li>");

  //Allow superusers to back-date requests
    $('#hold-request-form #from').removeClass('datepickerfrom').addClass('datepicker');

  //Allow superusers access to restricted catalogging tools
    $('#batchedit').show();
    $('#batchdelete').show();
    $('#deleteallitems').show();
    $('#batchedit-disabled').show();
    $('#batchdelete-disabled').show();
    $('#deleteallitems-disabled').show();
    $("#cat_addbooks li:contains('Z Framework')").show();
    $("#cat_addbooks li:contains('DVD framework')").show();
    $("#cat_addbooks li:contains('Online resource')").show();

  //Add button to show all pending patron updates
    $('#yui-main > h2:contains(Update patron records)').parent().prepend("<button id='pudshow' type='button'>Show all pending updates</button>");
    $("#pudshow").click( function() {
      $("#pudshow").hide();
      $('#pending_updates h3 a:not(:contains("('+loglibnode+'"))').parent().show();
      $('#pending_updates .ui-accordion-content:first').show();
    });

//Tools > News
  //BEGIN Enable News features for superlibrarians
    $("#tools_koha-news .yui-t7 fieldset.rows > ol").prepend("<button id='newsshow' type='button' style='margin: 10px;'>Release limits</button>");
    $("#newsshow").click( function() {
      $("#newsshow").fadeOut();
      $('#tools_koha-news option').show();
      $('#tools_koha-news option').removeAttr("disabled");
      $("#tools_koha-news .yui-t7 #branch option:contains('All libraries')").attr("selected", "selected");
      $("#tools_koha-news #number").val("");
    });

  //Tools > LIBRARY NAME Calendar
    $("#tools_holidays #branch").after("<button id='calshow' type='button' style='margin: 10px;'>Choose any branch</button>");
    $("#calshow").click( function() {
      $("#calshow").fadeOut();
      $('#tools_holidays option').show();
    });

  //BEGIN Show "Duplicate" and "Schedule" option on action button
    $("#table_reports a:contains('Duplicate')").show();
    $("#table_reports a:contains('Schedule')").show();

  //GHW - movie type select
    $('#searchterms').after("<button id='movselectx' type='button'  style='margin: 5px'>Select all movie types</button>");
    $("#movselectx").click( function() {
      $("#itypephr-77, #itypephr-81, #itypephr-86, #itypephr-91").attr("checked","checked");
    });

  //GHW - load all reports in descending order
    $('#table_reports').on("init.dt", function () {
      var table = $('#table_reports').DataTable();
      table.page.len(-1);
      table.order([1, "desc"]);
      table.draw();
    });

//BEGIN Onetime

$('#subfield9523').show();

//END Onetime

};

//BEGIN SCHOOL
  /*
  //BEGIN redirect school holds to nearest public library during the summer
    $("#pickup option[value='PHAXTELL']").attr("value","SENECA").html('Prairie Hills - Axtell: Closed to requests till fall');
    $("#pickup option[value='PHSES']").attr("value","SABETHA").html('Prairie Hills - Sabetha Elementary: Closed to requests till fall');
    $("#pickup option[value='PHSHS']").attr("value","SABETHA").html('Prairie Hills - Sabetha High: Closed to requests till fall');
    $("#pickup option[value='PHSMS']").attr("value","SABETHA").html('Prairie Hills - Sabetha Middle: Closed to requests till fall');
    $("#pickup option[value='PHWAC']").attr("value","WETMORE").html('Prairie Hills - Wetmore: Closed to requests till fall');
  */

//Work on the expired patron project
 $(".patronattributelabel:contains('Account expiration')").wrap("<span style='background-color: Red;color: white;'></span>");
 $(".patronattributelabel:contains('Account expiration'), #pat_moremember #aai_EXPIRED").closest("body").addClass("expiredpatronx");
 $(".expiredpatronx #addchild, .expiredpatronx #changepassword, .expiredpatronx #duplicate, .expiredpatronx #searchtohold, .expiredpatronx .btn-group, .expiredpatronx a:contains('Renew'), .expiredpatronx #barcode, .expiredpatronx #menu a:contains(Batch check out)").hide();
 $('.expiredpatronx #barcode').parent().prepend("<p style='background: #FFFF00;font-size: 110%;font-weight: bold;'><br />This patron's account has been expired for a very long time and the account is scheduled to be automatically deleted.  The patron cannot check out items until the 'Account expiration' message has been removed.<br /><br />First click the 'EDIT' button and clear the 'Account expiration' message, then update the patron's contact information and click on 'Save.'  Then make sure their account has been renewed before proceeding.<br /> </p>");
 $("#aai_EXPIRED").css("background-color","yellow");

//Circulation > Holds queue > Results
 //BEGIN Create button to prep holds queue for printing
  $("#circ_view_holdsqueue .yui-g .results").after("<button id='holdshrink' type='button'  style='margin: 5px'>Shrink table for printing</button>");
  $("#holdshrink").click( function() {
   $("#holdst").attr("style","width: 800px;");
  });

// -- to move
 if ($('#circ_needsconfirmation').length){
  $('#findborrower').blur();
 }

// -- to move
 $("#rep_guided_reports_start label:contains('or a % symbol')").next().val("%");
 $("#rep_guided_reports_start label:contains('etween start date:')").next().val("01/01/2010");
 $("#rep_guided_reports_start label:contains('and end date:')").next().val("12/31/2020");
 $("#rep_guided_reports_start label:contains('greater than')").next().val("0");

// -- to move
 $("#amountwrittenoff").attr("type", "number");
 $("#amountwrittenoff").attr("step", "any");
 $("#amountwrittenoff").attr("min", "0");
 $("#amountwrittenoff").attr("max", $("#amountwrittenoff").val());
 $("#readingrec th.title-string:nth-child(11)").html("Date the item was <br /> lost or returned");

//expired patron -- to move
 //BEGIN Enhance expiration date on patron details page
  $("#patron-library-details li:contains('Expiration date: ')").attr('id','patronExpiration');
  var ed=new Date();
  var edat=( '0' + (ed.getDate()) ).slice( -2 );
  var emon=( '0' + (ed.getMonth()+1) ).slice( -2 );
  var eyear=ed.getFullYear();
  var todaysDate=eyear+'-'+emon+'-'+edat;
  ed.setDate(ed.getDate()+30);
  edat=( '0' + (ed.getDate()) ).slice( -2 );
  emon=( '0' + (ed.getMonth()+1) ).slice( -2 );
  eyear=ed.getFullYear();
  var expireSoon=eyear+'-'+emon+'-'+edat;
  ed=new Date($("#patronExpiration").text().match(/\d{2}\/\d{2}\/\d{4}/g));
  edat=( '0' + (ed.getDate()) ).slice( -2 );
  emon=( '0' + (ed.getMonth()+1) ).slice( -2 );
  eyear=ed.getFullYear();
  var expireDate=eyear+'-'+emon+'-'+edat;
  if(expireDate >= todaysDate && expireDate < expireSoon){
   $("#patronExpiration").attr('style','color: red; font-size: 125%;').append(' <b><i>(Expires soon!)</i></b>');
  }
  if(expireDate < todaysDate){
   $("#patronExpiration").attr('style','color: red; font-size: 125%;').append(' <b><i>(EXPIRED!)</i></b>');
  };

 //BEGIN Add button to lists to run report 3063 -- to move
  $("#lists_shelves #toolbar #printlist").parent().after("<div class='btn-group'><button id='printr3063' type='button' class='btn btn-default btn-sm'>Show printable list with only title/author information</button></div>");
  var listnum=$("#lists_shelves #listform > input:nth-child(3)").val();
  $("#printr3063").click( function() {
   window.open('https://staff.nexpresslibrary.org/cgi-bin/koha/reports/guided_reports.pl?phase=Run+this+report&reports=3063&sql_params=' + listnum + '&limit=2000');
  });

//convert patron messages to HTML - Caboose, 12.20.17 -- to move
 $.fn.toHtml=function(){
  return $(this).html($(this).text())
 }
 $('#circ_circulation #messages .circ-hlt').each(function() {
  $(this).toHtml();
 });

//$('#intranet-circulation-home-html, #intranet-reports-home-html').attr('style', 'align: center; width: 80%; margin-left: auto; margin-right: auto;');
//$('#intranet-circulation-home-html, #intranet-reports-home-html').insertBefore('#changelanguage');



//$("#hold-request-form #holdnotes").attr("required", true);


var hrbranamex=$(".logged-in-branch-name").text().trim().substring(0, 5);

$('tr').each(function(){
 if($('td:nth-child(4):not(:contains("' + hrbranamex + '"))', this).length){
  $(this).addClass('nonlocalrow');
 }
});

$('tr').each(function(){
 if($('td:nth-child(4):contains("' + hrbranamex + '")', this).length){
  $(this).addClass('localrow');
 }
});

$('.nonlocalrow input[type=radio]').change(function () {
 if ($(".nonlocalrow input[type=radio]").is(":checked")) {
  $('#holdnotes').attr('class','specificitem');
 }
});

$('.localrow input[type=radio]').change(function () {
 if ($(".localrow input[type=radio]").is(":checked")) {
  $('#holdnotes').removeAttr('class');
 }
});

$('#hold-request-form input[type="submit"]').one( "click", function(){
 $(".specificitem").val( function( index, val ) {
  return val + " - item specific request placed by "+ ($(".loggedinusername").html().trim())+ " at "+ ($(".logged-in-branch-code").html().trim())
 })
});


$('#intranet-circulation-home-html, #intranet-reports-home-html').attr('style', 'align: center; width: 80%; margin-left: auto; margin-right: auto;');
$('#intranet-circulation-home-html, #intranet-reports-home-html').insertBefore('#changelanguage');

  $('.modal-body li:contains("Patron notification")').html(function(index, html) {
   return html.replace('Patron notification', 'Automatic notification');
  });

  $('.modal-body li:contains("Patron is not notified")').html(function(index, html) {
   return html.replace('Patron is not notified', 'No automatic notification configured for this patron');
  });

//never delete anything below this comment
});
